# N9N System Diagrams

## 1. High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                         USER (WhatsApp)                          │
│                    Sends/Receives Messages                       │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                    WhatsApp Web (Browser)                        │
│                   whatsapp-web.js + Puppeteer                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      N9N Backend (NestJS)                        │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  WhatsApp    │  │  Execution   │  │   Event      │         │
│  │  Manager     │→ │   Engine     │→ │   Bus        │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────────┐
        │   PostgreSQL     │      │   WebSocket          │
        │   (State)        │      │   (Real-time)        │
        └──────────────────┘      └──────────────────────┘
                    │                           │
                    ▼                           ▼
        ┌──────────────────┐      ┌──────────────────────┐
        │   Redis          │      │   Frontend           │
        │   (Locks/TTL)    │      │   (Next.js)          │
        └──────────────────┘      └──────────────────────┘
```

## 2. Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Message Received from WhatsApp                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Active Execution?     │
                    └───────────────────────┘
                        │               │
                       YES             NO
                        │               │
                        ▼               ▼
            ┌───────────────┐   ┌─────────────────┐
            │ Resume        │   │ Match Trigger?  │
            │ Execution     │   └─────────────────┘
            └───────────────┘           │
                        │              YES
                        │               │
                        │               ▼
                        │   ┌─────────────────────┐
                        │   │ Create New          │
                        │   │ Execution           │
                        │   └─────────────────────┘
                        │               │
                        └───────┬───────┘
                                ▼
                    ┌───────────────────────┐
                    │ Execution Loop        │
                    │ (State Machine)       │
                    └───────────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
        ┌───────────┐   ┌───────────┐   ┌───────────┐
        │ Execute   │   │ Pause &   │   │ Complete  │
        │ Node      │   │ Wait      │   │ & End     │
        └───────────┘   └───────────┘   └───────────┘
                │               │               │
                ▼               ▼               ▼
        ┌───────────┐   ┌───────────┐   ┌───────────┐
        │ Next      │   │ Save      │   │ Emit      │
        │ Node      │   │ State     │   │ Event     │
        └───────────┘   └───────────┘   └───────────┘
```

## 3. State Machine Lifecycle

```
        START
          │
          ▼
    ┌──────────┐
    │ RUNNING  │◄─────────┐
    └──────────┘          │
          │               │
          │ Node needs    │ Message
          │ user input    │ received
          │               │
          ▼               │
    ┌──────────┐          │
    │ WAITING  │──────────┘
    └──────────┘
          │
          │ Timeout OR
          │ Reached END
          │
          ▼
    ┌──────────────────────┐
    │ COMPLETED / EXPIRED  │
    │      / ERROR         │
    └──────────────────────┘
          │
          ▼
        END
```

## 4. Node Execution Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        Execute Node                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ SEND_MESSAGE  │               │ WAIT_REPLY    │
        │               │               │               │
        │ • Interpolate │               │ • Set timeout │
        │ • Send        │               │ • Save state  │
        │ • Continue    │               │ • PAUSE       │
        └───────────────┘               └───────────────┘
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ CONDITION     │               │ END           │
        │               │               │               │
        │ • Evaluate    │               │ • Collect     │
        │ • Branch      │               │   output      │
        │ • Continue    │               │ • Complete    │
        └───────────────┘               └───────────────┘
```

## 5. Multi-Tenant Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                          Tenant A                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Workflows    │  │ Sessions     │  │ Executions   │         │
│  │ (tenantId=A) │  │ (tenantId=A) │  │ (tenantId=A) │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          Tenant B                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Workflows    │  │ Sessions     │  │ Executions   │         │
│  │ (tenantId=B) │  │ (tenantId=B) │  │ (tenantId=B) │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘

                    ▼ ALL QUERIES FILTERED BY tenantId ▼

┌─────────────────────────────────────────────────────────────────┐
│                        PostgreSQL Database                       │
│                     (Complete Data Isolation)                    │
└─────────────────────────────────────────────────────────────────┘
```

## 6. Context Data Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      Execution Context                           │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  {                                                        │  │
│  │    globals: { workflowId: "..." },                       │  │
│  │    variables: { userName: "John", age: 25 },             │  │
│  │    input: { message: "Hello" },                          │  │
│  │    output: { response: "Hi John!" }                      │  │
│  │  }                                                        │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ Node 1        │               │ Node 2        │
        │               │               │               │
        │ Read:         │               │ Read:         │
        │ variables.*   │───Context────▶│ variables.*   │
        │               │   Passed      │               │
        │ Write:        │               │ Write:        │
        │ variables.x   │               │ variables.y   │
        └───────────────┘               └───────────────┘
```

## 7. Concurrency Control

```
┌─────────────────────────────────────────────────────────────────┐
│                    Incoming Message                              │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                ┌───────────────────────────────┐
                │ Try Acquire Lock              │
                │ Key: tenant:session:contact   │
                └───────────────────────────────┘
                        │               │
                    SUCCESS          FAILURE
                        │               │
                        ▼               ▼
            ┌───────────────┐   ┌─────────────────┐
            │ Process       │   │ Reject:         │
            │ Message       │   │ Already         │
            │               │   │ Processing      │
            └───────────────┘   └─────────────────┘
                        │
                        ▼
            ┌───────────────────┐
            │ Release Lock      │
            └───────────────────┘
```

## 8. TTL & Expiration System

```
┌─────────────────────────────────────────────────────────────────┐
│                    Execution Created                             │
│                    expiresAt = now + 24h                         │
└─────────────────────────────────────────────────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ Global TTL    │               │ Node TTL      │
        │ (24 hours)    │               │ (5 minutes)   │
        └───────────────┘               └───────────────┘
                │                               │
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ Worker checks │               │ Redis timeout │
        │ every minute  │               │ per node      │
        └───────────────┘               └───────────────┘
                │                               │
                └───────────────┬───────────────┘
                                ▼
                    ┌───────────────────────┐
                    │ Execution EXPIRED     │
                    │ Status updated        │
                    │ Locks released        │
                    └───────────────────────┘
```

## 9. Event System Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    Action Occurs                                 │
│              (Node executed, status changed, etc)                │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                    ┌───────────────────────┐
                    │ Emit Event            │
                    │ (EventBusService)     │
                    └───────────────────────┘
                                │
                ┌───────────────┴───────────────┐
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ Persist to    │               │ Broadcast via │
        │ Database      │               │ WebSocket     │
        │ (Audit Log)   │               │ (Real-time)   │
        └───────────────┘               └───────────────┘
                │                               │
                ▼                               ▼
        ┌───────────────┐               ┌───────────────┐
        │ execution_    │               │ Frontend      │
        │ logs table    │               │ Updates UI    │
        └───────────────┘               └───────────────┘
```

## 10. Workflow Validation

```
┌─────────────────────────────────────────────────────────────────┐
│                    Workflow Submitted                            │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
                ┌───────────────────────────────┐
                │ Validation Checks             │
                └───────────────────────────────┘
                                │
        ┌───────────────────────┼───────────────────────┐
        ▼                       ▼                       ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ Has Trigger?  │   │ Has END node? │   │ Valid edges?  │
│ ✓ Required    │   │ ✓ Required    │   │ ✓ Required    │
└───────────────┘   └───────────────┘   └───────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                ▼
                        ┌───────────────┐
                        │ All Valid?    │
                        └───────────────┘
                            │       │
                          YES      NO
                            │       │
                            ▼       ▼
                    ┌─────────┐ ┌─────────┐
                    │ Save    │ │ Reject  │
                    └─────────┘ └─────────┘
```

## 11. WhatsApp Session Lifecycle

```
        ┌─────────────┐
        │ Create      │
        │ Session     │
        └─────────────┘
                │
                ▼
        ┌─────────────┐
        │ Initialize  │
        │ Client      │
        └─────────────┘
                │
                ▼
        ┌─────────────┐
        │ QR_CODE     │◄───────┐
        │ Status      │        │
        └─────────────┘        │
                │              │
        User scans QR         │
                │              │
                ▼              │
        ┌─────────────┐        │
        │ CONNECTED   │        │
        │ Status      │        │
        └─────────────┘        │
                │              │
        Receives messages      │
                │              │
        ┌───────┴────────┐     │
        │                │     │
        ▼                ▼     │
    Continue      Disconnected │
    Working           │        │
                      └────────┘
```

## 12. Database Schema Relationships

```
┌─────────────┐
│   Tenant    │
└─────────────┘
       │
       │ 1:N
       │
       ├──────────────────┬──────────────────┬──────────────────┐
       ▼                  ▼                  ▼                  ▼
┌─────────────┐   ┌─────────────┐   ┌─────────────┐   ┌─────────────┐
│  Workflow   │   │  WhatsApp   │   │  Workflow   │   │  Execution  │
│             │   │  Session    │   │  Execution  │   │  Log        │
└─────────────┘   └─────────────┘   └─────────────┘   └─────────────┘
       │                  │                  │
       │ 1:N              │ 1:N              │
       │                  │                  │
       └──────────────────┴──────────────────┘
                          │
                          ▼
                  ┌─────────────┐
                  │  Workflow   │
                  │  Execution  │
                  └─────────────┘
```

## Legend

- `│` `─` `┌` `└` `┐` `┘` : Box drawing
- `▼` `▲` : Flow direction
- `→` `←` : Data flow
- `◄` `►` : Bidirectional
- `1:N` : One-to-many relationship
- `✓` : Validation check

---

These diagrams provide a visual understanding of how N9N works internally. Use them as reference when:

- Understanding the architecture
- Debugging issues
- Explaining the system to others
- Planning extensions

